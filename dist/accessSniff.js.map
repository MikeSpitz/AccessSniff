{"version":3,"sources":["src/accessSniff.js"],"names":[],"mappings":"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","file":"src/accessSniff.js","sourcesContent":["/*\n * AccessSniff\n * https://yargalot@github.com/yargalot/AccessSniff\n *\n * Copyright (c) 2015 Steven John Miller\n * Licensed under the MIT license.\n */\n\nvar fs        = require('fs');\nvar path      = require('path');\nvar http      = require('http');\nvar chalk     = require('chalk');\n// var Promise   = require('bluebird');\nvar validator = require('validator');\nvar _         = require('underscore');\nvar asset     = path.join.bind(null, __dirname, '..');\nvar logger    = require('./logger.js');\nvar reporter  = require('./reports.js');\n\nvar childProcess  = require('child_process');\nvar phantomPath   = require('phantomjs').path;\n\nvar _that;\n\nclass Accessibility {\n\n  constructor(options) {\n\n    this.basepath     = process.cwd();\n    this.failTask     = 0;\n    this.log          = '';\n    this.fileContents = '';\n\n    if (options.accessibilityrc) {\n\n      var rcOptions = fs.readFileSync(process.cwd() + '/.accessibilityrc', 'utf8', (err, data)  => {\n        if (err) {\n          console.error(err);\n          return;\n        }\n\n        return data;\n      });\n\n      options = _.extend(options, JSON.parse(rcOptions));\n\n    }\n\n    // Defaults options with input options\n    _.defaults(options, Accessibility.Defaults);\n\n    this.options = options;\n\n    _that = this;\n\n  }\n\n  /**\n  * The Message Terminal, choo choo\n  *\n  *\n  */\n  terminalLog(msg, trace) {\n\n    var options = _that.options;\n    var message = {};\n    var msgSplit = msg.split('|');\n    var reportLevels = [];\n\n    // If ignore get the hell out\n    if (_.contains(options.ignore, msgSplit[1])) {\n      return;\n    }\n\n    // Report levels\n    _.each(options.reportLevels, (value, key, list) => {\n      if (value) {\n        reportLevels.push(key.toUpperCase());\n      }\n    });\n\n    // Start the Logging\n    if (_.contains(reportLevels, msgSplit[0])) {\n\n      var element = {\n        node:   msgSplit[3],\n        class:  msgSplit[4],\n        id:     msgSplit[5]\n      };\n\n      message = {\n        heading:      msgSplit[0],\n        issue:        msgSplit[1],\n        element:      element,\n        position:     this.getElementPosition(msgSplit[3]),\n        description:  msgSplit[2],\n      };\n\n      if (message.heading === 'ERROR') {\n        this.failTask += 1;\n      }\n\n      if (options.verbose) {\n        logger.generalMessage(message);\n      }\n\n    } else {\n\n      message = null;\n\n    }\n\n    return message;\n\n  }\n\n  // Get Line Positions\n  getElementPosition(htmlString) {\n\n    var position = {};\n    var htmlArray = this.fileContents.split('\\n');\n\n    htmlArray.every((element, lineNumber) => {\n      if (!element.match(htmlString)) {\n        return true;\n      }\n\n      var columnNumber = 0;\n      var colIndex = 0;\n      var pattern = /(\\s|\\t)/g;\n\n      while (element.charAt(colIndex).match(pattern)) {\n        columnNumber++;\n        colIndex++;\n      }\n\n      position.lineNumber = lineNumber;\n      position.columnNumber = columnNumber;\n\n      return false;\n\n    });\n\n    return position;\n\n  }\n\n  parseOutput(file, deferred) {\n\n    var test = file.split('\\n');\n    var _this = this;\n    var messageLog = [];\n\n    test.every((element, index, array) => {\n\n      var something = JSON.parse(element);\n\n      if (something[0] === 'wcaglint.done') {\n        return false;\n      }\n\n      var message = _this.terminalLog(something[1]);\n\n      if (message) {\n        messageLog.push(message);\n      }\n\n      return true;\n\n    });\n\n    if (this.options.reportType) {\n      reporter.terminal(messageLog, _this.options, () => {\n        deferred.fulfill(messageLog);\n      });\n    } else {\n      deferred.fulfill(messageLog);\n    }\n\n  }\n\n  getContents(file, callback) {\n\n    var contents;\n    var isUrl = validator.isURL(file);\n\n    if (isUrl) {\n      http.get(file, (response) => {\n\n        response.setEncoding('utf8');\n\n        response.on('data', (data) => {\n          callback(data);\n        });\n\n      });\n    } else {\n      fs.readFile(file, 'utf8', (err, data) => {\n        callback(data.toString());\n      });\n    }\n\n  }\n\n  /**\n  * Run task\n  *\n  * @param {Object} grunt - grunt object\n  *\n  * @returns {Object} a promise that resolves with final html\n  *\n  */\n  run(filesInput, callback) {\n\n    var files   = Promise.resolve(filesInput);\n    var _this = this;\n\n    var promiseMapOptions = {\n      concurrency: 1\n    };\n\n    return files\n      .bind(this)\n      .map(function(file) {\n\n        var deferredOutside = Promise.pending();\n\n        var childArgs = [\n          path.join(__dirname, './phantom.js'),\n          file,\n          this.options.accessibilityLevel\n        ];\n\n        this.options.fileName = path.basename(childArgs[1], '.html');\n\n        logger.startMessage('Testing ' + childArgs[1]);\n\n        // Get file contents\n        this.getContents(file, (contents) => {\n          _this.fileContents = contents;\n        });\n\n        // Call Phantom\n        childProcess.execFile(phantomPath, childArgs, (err, stdout, stderr) => {\n\n          if (err) {\n            deferredOutside.fulfill();\n          }\n\n          _this.parseOutput(stdout, deferredOutside);\n\n        });\n\n        return deferredOutside.promise;\n\n      }, promiseMapOptions)\n      .then((messageLog, error) => {\n\n        if (typeof callback === 'function') {\n          callback(messageLog, _this.failTask);\n        }\n\n        return true;\n\n      })\n      .catch((err) => {\n\n        console.error('There was an error');\n        console.error(err);\n\n        return err;\n\n      });\n\n  }\n}\n\nAccessibility.Defaults = {\n  ignore: [],\n  verbose: true,\n  force: false,\n  domElement: true,\n  reportType: null,\n  reportLevels: {\n    notice: true,\n    warning: true,\n    error: true\n  },\n  reportLocation : 'reports',\n  accessibilityrc: false,\n  accessibilityLevel: 'WCAG2A'\n};\n\nAccessibility.start = function(files, options, callback) {\n\n  var task = new Accessibility(options);\n\n  return task.run(files, callback);\n\n};\n\nmodule.exports = Accessibility;\n"]}